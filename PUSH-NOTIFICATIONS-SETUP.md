# Remote Push Notifications Setup Guide

## Overview

MessageAI now uses **true remote push notifications** via Firebase Cloud Functions, Expo Push Service, APNs, and FCM.

**What this means:**
- ‚úÖ Notifications sent from server (Cloud Functions)
- ‚úÖ Works in foreground and background
- ‚úÖ Delivered via APNs (iOS) and FCM (Android)
- ‚úÖ Compliant with MVP requirements

**What won't work:**
- ‚ùå iOS Simulator (no APNs support)
- ‚ùå Expo Go (limited push support)
- ‚ùå Local development without dev build

---

## Architecture

```
User A sends message
  ‚Üì
Message written to Firestore
  ‚Üì
Cloud Function (sendMessageNotification) triggers
  ‚Üì
Function gets User B's Expo push token from Firestore
  ‚Üì
Function sends push via Expo Push API
  ‚Üì
Expo routes to APNs (iOS) or FCM (Android)
  ‚Üì
Device receives remote push notification
  ‚Üì
Foreground handler displays notification
```

---

## Requirements

### Firebase Requirements
- ‚úÖ **Firebase Blaze Plan** (Pay-as-you-go) - Required for Cloud Functions
- ‚úÖ **Cloud Functions enabled** in Firebase Console
- ‚úÖ **Firestore and Storage already configured**

### Apple Requirements (iOS)
- ‚úÖ **Apple Developer Account** ($99/year)
- ‚úÖ **APNs Key** (.p8 file from Apple Developer Console)
- ‚úÖ **Bundle ID**: `com.dawnrobotics.messageai`
- ‚úÖ **Push Notifications capability** enabled in App ID

### Android Requirements
- ‚úÖ **Firebase project** (already set up)
- ‚úÖ **FCM automatically configured** when using Firebase
- ‚úÖ **google-services.json** will be generated by EAS

### EAS Requirements
- ‚úÖ **EAS CLI installed**: `npm install -g eas-cli`
- ‚úÖ **EAS Account** (free tier works)
- ‚úÖ **Project ID**: `e0362f41-e619-4df8-ad3a-4dbcff0ce438`

---

## Setup Steps

### Step 1: Install Cloud Functions Dependencies

```bash
cd functions
npm install
```

This installs:
- `firebase-functions` - Cloud Functions SDK
- `firebase-admin` - Admin SDK for Firestore access
- `expo-server-sdk` - Send pushes via Expo

### Step 2: Deploy Cloud Functions

```bash
# Build and deploy
firebase deploy --only functions

# Or deploy with logs
firebase deploy --only functions && firebase functions:log
```

**Expected output:**
```
‚úî  functions: Finished running predeploy script.
‚úî  functions[sendMessageNotification(us-central1)]: Successful create operation.
‚úî  Deploy complete!
```

### Step 3: Configure APNs in EAS (iOS)

```bash
# Login to EAS
eas login

# Configure push notifications
eas credentials

# Select:
# - Platform: iOS
# - Build Profile: development (or production)
# - Select: Push Notifications
# - Upload your .p8 key file
```

**Where to get .p8 key:**
1. Go to https://developer.apple.com/account/resources/authkeys/list
2. Create new key with "Apple Push Notifications service (APNs)" enabled
3. Download .p8 file (only chance to download!)
4. Note the Key ID and Team ID

### Step 4: Build Development Client

**iOS:**
```bash
cd app
eas build --profile development --platform ios
```

**Android:**
```bash
cd app
eas build --profile development --platform android
```

**Or both:**
```bash
eas build --profile development --platform all
```

**Build time:** 10-20 minutes per platform

### Step 5: Install on Physical Device

**iOS:**
```bash
# After build completes
eas build:run -p ios

# Or install from EAS dashboard
# https://expo.dev/accounts/[your-account]/projects/app/builds
```

**Android:**
```bash
# After build completes
eas build:run -p android

# Or download APK from EAS dashboard
```

---

## Testing Push Notifications

### ‚ö†Ô∏è Testing Requirements

**Must use:**
- ‚úÖ Physical iOS device (iPhone with iOS 13+)
- ‚úÖ Physical Android device (with Google Play Services)
- ‚úÖ EAS Development Build or TestFlight build

**Cannot test with:**
- ‚ùå iOS Simulator (no APNs)
- ‚ùå Android Emulator (limited FCM)
- ‚ùå Expo Go (no remote push)

### Test Scenario 1: Foreground Notification

1. **Device A:** Login as User A
2. **Device B:** Login as User B
3. **Device B:** Stay on home screen (NOT in chat with User A)
4. **Device A:** Send message to User B
5. **Device B:** Should see push notification banner at top

**Expected:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üîî User A             ‚îÇ
‚îÇ Hey there!            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Test Scenario 2: Background Notification

1. **Device B:** Close app (background)
2. **Device A:** Send message to User B
3. **Device B:** Should see lock screen notification

**Expected:**
- Lock screen shows notification
- Badge count increases
- Tap notification ‚Üí Opens app ‚Üí Navigates to chat

### Test Scenario 3: Suppression

1. **Device B:** Open chat with User A
2. **Device A:** Send message
3. **Device B:** Should NOT see notification (already viewing)

**Expected:**
- No notification (suppressed)
- Message appears in chat immediately

---

## Troubleshooting

### No Notifications Received

**Check Cloud Functions logs:**
```bash
firebase functions:log
```

**Look for:**
```
üì¨ New message created
üì§ Sending notifications to 1 recipient(s)
‚úÖ Queued push for user: abc12345
üì§ Sending 1 notification(s) in 1 chunk(s)
‚úÖ Chunk sent: 1 tickets
üéâ Push notification job complete: 1 sent
```

**If logs show "No push token":**
- User hasn't registered for push
- Check Firestore `users/{uid}/pushToken` field
- Verify `registerForPushNotifications` was called on login

**If logs show "Suppressed":**
- User is viewing the conversation
- Check `presence.activeConversationId` in Firestore
- This is expected behavior

### Push Token Not Registered

**Check app logs:**
```
‚ö†Ô∏è Push notifications require a physical device
```

**Solution:**
- Build with EAS: `eas build --profile development`
- Install on physical device
- Cannot test on simulator

### APNs Configuration Issues

**Error: "Invalid APNs credentials"**

**Solution:**
1. Verify .p8 key is valid
2. Check Key ID matches
3. Ensure Bundle ID matches: `com.dawnrobotics.messageai`
4. Re-run: `eas credentials`

### FCM Configuration Issues

**Android notifications not working:**

**Check:**
1. `google-services.json` present in build
2. FCM enabled in Firebase Console
3. Device has Google Play Services

---

## Deployment Checklist

### Before Deploying to Production:

- [ ] Firebase Blaze plan enabled
- [ ] Cloud Functions deployed: `firebase deploy --only functions`
- [ ] Firestore rules deployed: `firebase deploy --only firestore:rules`
- [ ] APNs credentials configured in EAS
- [ ] FCM configured in Firebase Console
- [ ] EAS production build created
- [ ] Tested on physical iOS device
- [ ] Tested on physical Android device
- [ ] Foreground notifications working
- [ ] Background notifications working
- [ ] Suppression logic working
- [ ] Tap-to-navigate working

---

## Costs

### Firebase Blaze Plan

**Cloud Functions:**
- Free tier: 2M invocations/month
- After: $0.40 per million invocations
- Typical usage: ~5K invocations/day = 150K/month (within free tier)

**Expo Push Service:**
- Free for all usage
- No limits

**APNs:**
- Free (included with Apple Developer Program)

**FCM:**
- Free unlimited

**Expected monthly cost:**
- Small app (< 1000 users): $0 (within free tier)
- Medium app (< 10K users): $0-5/month
- Large app: Scales with usage

---

## File Structure

```
MessageAI/
‚îú‚îÄ‚îÄ functions/                       # Cloud Functions (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts                # sendMessageNotification function
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îî‚îÄ‚îÄ .gitignore
‚îÇ
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ src/services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ notificationService.ts  # UPDATED: Push token registration
‚îÇ   ‚îú‚îÄ‚îÄ src/types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts                # UPDATED: User type with pushToken
‚îÇ   ‚îî‚îÄ‚îÄ app/
‚îÇ       ‚îî‚îÄ‚îÄ _layout.tsx             # UPDATED: Calls registerForPushNotifications
‚îÇ
‚îú‚îÄ‚îÄ firebase.json                    # UPDATED: Functions config added
‚îî‚îÄ‚îÄ firestore.rules                  # UPDATED: Allow pushToken updates
```

---

## API Reference

### Client (notificationService.ts)

**`registerForPushNotifications(userId: string): Promise<string | null>`**
- Gets Expo push token from device
- Stores in Firestore `users/{uid}/pushToken`
- Returns token or null if unavailable

**`setupNotificationTapHandler(): void`**
- Listens for notification taps
- Navigates to conversation

**`setNotificationHandler(config)`**
- Configures foreground display
- Handles suppression logic

### Server (Cloud Function)

**`sendMessageNotification`**
- Trigger: `conversations/{cid}/messages/{mid}` onCreate
- Fetches recipient push tokens
- Checks suppression (activeConversationId)
- Sends via Expo Push API
- Batches notifications for efficiency

---

## Security

### Push Token Storage
- Stored in Firestore: `users/{uid}/pushToken`
- Only accessible to authenticated users (read)
- Only writable by user themselves or Cloud Functions
- Token refresh handled automatically

### Notification Suppression
- Checks `presence.activeConversationId`
- No notifications if viewing that conversation
- Prevents spam and improves UX

### Data in Notifications
- Sender name (display name)
- Message preview (first 200 chars)
- Conversation ID (for navigation)
- No sensitive data exposed

---

## Next Steps

1. **Enable Firebase Blaze Plan** in Firebase Console
2. **Deploy Cloud Functions**: `firebase deploy --only functions`
3. **Configure APNs** via EAS CLI: `eas credentials`
4. **Build development client**: `eas build --profile development --platform all`
5. **Install on devices** and test
6. **Verify notifications** work in foreground and background

---

## Support

**Firebase Functions Logs:**
```bash
firebase functions:log --only sendMessageNotification
```

**EAS Build Status:**
```bash
eas build:list
```

**Test Push Manually:**
Use Expo Push Tool: https://expo.dev/notifications

---

**Status:** Production-ready remote push notifications via APNs/FCM ‚úÖ

