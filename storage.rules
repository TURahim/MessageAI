rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Each message image lives under /conversations/{cid}/messages/{mid}/
    match /conversations/{cid}/messages/{mid}/{file} {
      allow read, write: if request.auth != null &&
        exists(/databases/$(database)/documents/conversations/$(cid)) &&
        (get(/databases/$(database)/documents/conversations/$(cid)).data.participants
          .hasAny([request.auth.uid]));
    }
  }
}
